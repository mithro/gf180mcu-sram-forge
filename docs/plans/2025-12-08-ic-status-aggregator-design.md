# IC Status Aggregator Design

Date: 2025-12-08

## Overview

Create a CLI command and GitHub Action that aggregates GitHub Actions status from all downstream IC repositories generated by sram-forge. The status is published to GitHub Pages as an interactive HTML dashboard.

## Goals

- Single view of build health across all downstream IC repos
- Correlate IC builds back to the sram-forge revision that generated them
- Detect regressions after sram-forge changes
- Periodic automated updates with GitHub Pages publishing

## Architecture

### CLI Structure

New `downstream` command group:

```bash
uv run sram-forge downstream list              # Human-readable repo list
uv run sram-forge downstream matrix            # JSON for workflow matrix
uv run sram-forge downstream status            # Terminal status (default)
uv run sram-forge downstream status --format md
uv run sram-forge downstream status --format json
uv run sram-forge downstream status --format html -o status.html
```

### Config File (Single Source of Truth)

**Location:** `sram_forge/db/data/downstream_repos.yaml`

```yaml
repos:
  - name: gf180mcu-ic-0p5x0p5-sram-u8b3k
    owner: mithro
    sram: u8b3k
    slot: 0p5x0p5
    config: examples/sram_0p5x0p5_u8b3k.yaml
    deploy_key_secret: DEPLOY_KEY_0P5X0P5

  - name: gf180mcu-ic-0p5x1-sram-u8b8k
    owner: mithro
    sram: u8b8k
    slot: 0p5x1
    config: examples/sram_0p5x1_u8b8k.yaml
    deploy_key_secret: DEPLOY_KEY_0P5X1

  - name: gf180mcu-ic-1x0p5-sram-u8b9k
    owner: mithro
    sram: u8b9k
    slot: 1x0p5
    config: examples/sram_1x0p5_u8b9k.yaml
    deploy_key_secret: DEPLOY_KEY_1X0P5

  - name: gf180mcu-ic-1x1-sram-u8b24k
    owner: mithro
    sram: u8b24k
    slot: 1x1
    config: examples/sram_1x1_u8b24k.yaml
    deploy_key_secret: DEPLOY_KEY_1X1
```

This file is used by:
1. `sram-forge downstream matrix` - outputs JSON for workflow
2. `sram-forge downstream status` - fetches status for each repo
3. `update-downstream.yml` - dynamic matrix loading

### Module Structure

```
sram_forge/
â”œâ”€â”€ status/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ fetcher.py          # Fetch workflow runs via gh CLI
â”‚   â”œâ”€â”€ models.py           # Pydantic models
â”‚   â”œâ”€â”€ reporter.py         # Format output (terminal, md, json, html)
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ status_page.html.j2
â”œâ”€â”€ models/
â”‚   â””â”€â”€ downstream.py       # DownstreamRepo model
â””â”€â”€ db/
    â”œâ”€â”€ data/
    â”‚   â””â”€â”€ downstream_repos.yaml
    â””â”€â”€ loader.py           # Add load_downstream_repos()
```

### Data Models

```python
# sram_forge/models/downstream.py
class DownstreamRepo(BaseModel):
    name: str
    owner: str
    sram: str           # e.g., "u8b3k" - display identifier
    slot: str           # e.g., "0p5x0p5"
    config: str         # Path to chip config YAML
    deploy_key_secret: str

# sram_forge/status/models.py
class WorkflowRun(BaseModel):
    repo: str
    sram: str
    slot: str
    workflow_name: str
    status: Literal["queued", "in_progress", "completed"]
    conclusion: Literal["success", "failure", "cancelled", "skipped"] | None
    run_id: int
    head_sha: str           # Downstream repo commit
    updated_at: datetime
    html_url: str
    forge_sha: str | None   # Extracted from commit message
    forge_run_id: int | None

class ForgeRevision(BaseModel):
    """Group IC runs by the sram-forge commit that generated them."""
    forge_sha: str
    forge_run_url: str | None
    timestamp: datetime
    runs: list[WorkflowRun]

    @property
    def summary(self) -> str:
        passing = sum(1 for r in self.runs if r.conclusion == "success")
        return f"{passing}/{len(self.runs)}"

    @property
    def all_passing(self) -> bool:
        return all(r.conclusion == "success" for r in self.runs)

class StatusReport(BaseModel):
    generated_at: datetime
    revisions: list[ForgeRevision]  # Grouped by forge commit
```

### Fetching Logic

```python
# sram_forge/status/fetcher.py

def fetch_workflow_runs(repo: str, limit: int = 5) -> list[dict]:
    """Fetch latest workflow runs for a repo using gh CLI."""
    result = subprocess.run(
        ["gh", "run", "list", "--repo", repo, "--limit", str(limit), "--json",
         "workflowName,status,conclusion,databaseId,headSha,updatedAt,url"],
        capture_output=True, text=True, check=True
    )
    return json.loads(result.stdout)

def get_forge_sha_from_commit(repo: str, sha: str) -> tuple[str | None, int | None]:
    """Parse downstream commit message to extract sram-forge source SHA."""
    result = subprocess.run(
        ["gh", "api", f"repos/{repo}/commits/{sha}", "--jq", ".commit.message"],
        capture_output=True, text=True
    )
    if result.returncode != 0:
        return None, None

    msg = result.stdout
    sha_match = re.search(r"Source commit: ([a-f0-9]+)", msg)
    run_match = re.search(r"/actions/runs/(\d+)", msg)

    return (
        sha_match.group(1) if sha_match else None,
        int(run_match.group(1)) if run_match else None
    )

def fetch_all_status(repos: list[DownstreamRepo]) -> StatusReport:
    """Fetch status for all downstream repos and group by forge revision."""
    all_runs = []

    for repo in repos:
        full_repo = f"{repo.owner}/{repo.name}"
        raw_runs = fetch_workflow_runs(full_repo)

        for raw in raw_runs:
            forge_sha, forge_run_id = get_forge_sha_from_commit(
                full_repo, raw["headSha"]
            )
            all_runs.append(WorkflowRun(
                repo=full_repo,
                sram=repo.sram,
                slot=repo.slot,
                workflow_name=raw["workflowName"],
                status=raw["status"],
                conclusion=raw.get("conclusion"),
                run_id=raw["databaseId"],
                head_sha=raw["headSha"],
                updated_at=datetime.fromisoformat(raw["updatedAt"].replace("Z", "+00:00")),
                html_url=raw["url"],
                forge_sha=forge_sha,
                forge_run_id=forge_run_id,
            ))

    # Group by forge_sha
    revisions = group_by_forge_revision(all_runs)

    return StatusReport(
        generated_at=datetime.now(UTC),
        revisions=revisions
    )
```

### Output Formats

**Terminal (default):**
```
sram-forge IC Status
====================
Last updated: 2025-12-08 14:30 UTC

ğŸ“¦ abc1234 (2h ago)                              4/4 âœ…
   âœ… u8b3k   âœ… u8b8k   âœ… u8b9k   âœ… u8b24k

ğŸ“¦ def5678 (1d ago)                              2/4 âŒ
   âœ… u8b3k   âŒ u8b8k   âŒ u8b9k   âœ… u8b24k

Summary: Latest revision passing
```

**Markdown:**
```markdown
## sram-forge IC Status

*Last updated: 2025-12-08 14:30 UTC*

### Revision abc1234 (4/4 passing)

| SRAM | Slot | Status | Workflow | Commit |
|------|------|--------|----------|--------|
| [u8b3k](link) | 0p5x0p5 | âœ… success | CI | [`4bfdbea`](link) |
| [u8b8k](link) | 0p5x1 | âœ… success | CI | [`f144201`](link) |
| ... | ... | ... | ... | ... |
```

**JSON:** Direct `StatusReport.model_dump_json()`

**HTML:** Self-contained page with interactive features

### HTML Page Features

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sram-forge IC Status                                       â”‚
â”‚  Last updated: 2025-12-08 14:30 UTC                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [All] [Passing] [Failing]              Summary: 4/4 âœ…     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ abc1234 (main, 2h ago)                        4/4 âœ…    â”‚
â”‚  â”œâ”€ âœ… u8b3k   âœ… u8b8k   âœ… u8b9k   âœ… u8b24k             â”‚
â”‚  â””â”€ [click to expand details]                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ def5678 (1d ago)                              2/4 âŒ    â”‚
â”‚  â”œâ”€ âœ… u8b3k   âŒ u8b8k   âŒ u8b9k   âœ… u8b24k             â”‚
â”‚  â””â”€ [click to expand details]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interactive features:**
- Filter buttons: All / Passing / Failing
- Click revision to expand/collapse detailed run info
- Expanded view: workflow name, duration, links to run and commit
- Failures highlighted with red background
- Click SRAM name to open repo's Actions page

**Self-contained:**
- Embedded `<style>` and `<script>`
- No external dependencies
- Works offline once loaded

### GitHub Actions Workflows

#### Updated: `update-downstream.yml`

```yaml
name: Update Downstream Repos

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  load-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - id: set-matrix
        run: echo "matrix=$(uv run sram-forge downstream matrix)" >> $GITHUB_OUTPUT

  update-downstream:
    needs: load-matrix
    name: Update ${{ matrix.sram }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-matrix.outputs.matrix) }}
    steps:
      # ... existing steps using matrix.repo, matrix.config, matrix.secret
```

#### New: `status-page.yml`

```yaml
name: Update Status Page

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:
  workflow_run:
    workflows: ["Update Downstream Repos"]
    types: [completed]

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync

      - name: Generate status page
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p _site
          uv run sram-forge downstream status --format html -o _site/index.html
          uv run sram-forge downstream status --format json -o _site/status.json

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
```

## Future Enhancements

- Filter by status (show only failures)
- Show build duration and timing trends
- Compare status before/after a sram-forge commit
- Slack/Discord notification on status change
- Badge generation for README
